# Взлом программы

### Описание взламываемой программы

Программа написана на языке ассемблера под архитектуру x86 и предназначается под использование на ПК под управлением DOS

### Подготовка к взлому

В первую очередь необходимо установить среду операционной системы DOS.
Мы будем использовать программу DosBox в сборке под Windows.

> [!Important]
> Если вы используете ОС Linux, то скачайте и установите [wine](https://wiki.archlinux.org/title/Wine_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)).
Это нужно для корректного запуска Windows приложений на Linux

Для этого нужно перейти по ссылке http://ded32.net.ru/

В правой части сайта найти ссылку: `Скачать DosBox + Asm`

![ded32](/img/ded32.png)

Затем следовать инструкциям установщика.

### Взлом через переполнение буффера ввода

В первую очередь стоит отметить, что будет являться корректным взломом без потери функциональности программы. 
- Программа должна вывести приветственное сообщение `Enter password:`
- Запросить ввод пароля (пользователь должен ввести комбинацию с нажатием Enter на конце)
- Программа должна вывести сообщение `Password correct`

Проанализировав код программы можно прийти к выводу, что количество символв, вводимое с клавиатуры никак не контролируется, а значит можно выйти за пределы буффера ввода и переписать данные, которые располагаются на ним.

Рассмотрим побайтную структуру буффера ввода:

![buffer](/img/buffer.png)

Как видно из картинки буффер(подчеркнут красным) занимает 10 байт, а значит может вместить в себя только 9 символов(и один под Enter).
А сразу за буффером следует байт доступа(выделен жёлтым). Именно этот байт проверяется при решении дать доступ или нет.

Следовательно для взлома нужно ввести в консоль 10 символов (и один Enter), чтобы переписать этот флаг ненулевым значением.

Напишем текстовый файл `password.txt` с содержанием:
```
0123456789

```
> [!Important] 
> Важно поставить в конце файла Enter, а также сохранить файл в формате CRLF. Это нужно для корректного завершения ввода, потому что в функции считывания стоит проверка на '\r' в завершении входной строки.

Вводим в консоль команду с перенаправлением ввода и получаем доступ:

```
crackme.com < password.txt
```

![first_crack](/img/first_crack.png)

Первый взлом завершен.

### Взлом через модификацию бинарного файла

Так как программа хеширует сама себя, то просто так изменить её содержимое не получится, программа выдаст ошибку валидности.

Проанализируем код программы:

![second_crack](/img/second_crack.png)

Первая функция подсчитывает и проверяет хэш всего файла.
Но если её стереть, то программа специально вызывает зависание всей системы. Внутри этой функции отменяется вызов функции-уничтожителя, следовательно если её не вызвать, то функция-уничтожитель будет вызвана. 
Поэтому мало удалить одну лишь функцию хэширования, нужно удалить вызов функции-уничтожителя, а также функции проверки пароля.

Всё что нужно удалить из кода подчёркнуто красным.
